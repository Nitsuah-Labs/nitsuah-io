#!/usr/bin/env sh
set -e

# Pre-commit wrapper: run project validation in a robust, cross-environment way
# - Prefer running 'npm run validate' so checks are centralized in package.json
# - If WSL is available, attempt to run validation inside WSL (where many devs keep node/npm)
# - Give clear instructions if dev-deps (prettier/eslint) are missing rather than failing with 'not found'

echo "Running pre-commit hook..."

# This hook aims to enforce the project's validation in a safe, VS Code-friendly way.
# Key principles:
# - Prefer running validation in the canonical WSL clone (~/nitsuah-io-wsl) when available.
# - Do NOT auto-modify or git-add files inside WSL (that would affect a different working tree).
# - Run checks (format:check + typecheck) only; if fixes are required, provide clear instructions.

run_wsl_checks() {
  echo "Running validation inside WSL clone ~/nitsuah-io-wsl (checks only)..."
  # Use the project's npm scripts; format:check will detect formatting problems without writing files.
  wsl -e bash -lc "cd ~/nitsuah-io-wsl && npm run wagmi --silent || true && npm run format:check --silent && npm run typecheck --silent"
}

run_local_checks() {
  echo "Running local validation (checks only)..."
  npm run wagmi --silent || true
  npm run format:check --silent
  npm run typecheck --silent
}

# Prefer running validation in WSL clone if WSL is available and the canonical clone appears populated
if command -v wsl >/dev/null 2>&1; then
  if wsl -e bash -lc "[ -d ~/nitsuah-io-wsl ]" >/dev/null 2>&1; then
    # Ensure dev deps were installed in the WSL clone
    if wsl -e bash -lc "[ -d ~/nitsuah-io-wsl/node_modules ]" >/dev/null 2>&1; then
      if run_wsl_checks; then
        exit 0
      else
        echo "Validation failed inside WSL clone. To fix: open WSL shell, run 'cd ~/nitsuah-io-wsl && npm ci' then run the failing commands (format or typecheck) to see fixes."
        echo "You can then run formatting in your editor or in WSL (npm run format) before re-trying the commit." >&2
        exit 1
      fi
    else
      echo "WSL clone exists but dev dependencies are missing in ~/nitsuah-io-wsl. Run inside WSL: 'cd ~/nitsuah-io-wsl && npm ci'" >&2
      exit 1
    fi
  fi
fi

# If we get here, either WSL isn't available or the canonical clone isn't present.
# Fall back to running checks in the local environment (the environment VS Code will typically run hooks from).
if command -v npm >/dev/null 2>&1; then
  if run_local_checks; then
    exit 0
  else
    echo "Local validation failed. Run 'npm ci' to install dev dependencies and re-run the commit, or open the project in WSL and run validation there." >&2
    exit 1
  fi
fi

echo "WARNING: npm not found in PATH and WSL either; skipping pre-commit validation."
echo "To enable hooks, install Node and run 'npm ci' or use the WSL canonical clone with dev deps installed." 
exit 0



