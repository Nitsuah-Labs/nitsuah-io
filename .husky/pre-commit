#!/usr/bin/env sh
set -e

# Pre-commit wrapper: run project validation in a robust, cross-environment way
# - Prefer running 'npm run validate' so checks are centralized in package.json
# - If WSL is available, attempt to run validation inside WSL (where many devs keep node/npm)
# - Give clear instructions if dev-deps (prettier/eslint) are missing rather than failing with 'not found'

echo "Running pre-commit hook..."

## Prefer running validation in a WSL clone that has dev deps installed.
# Some devs keep a WSL-local clone at ~/nitsuah-io-wsl where npm ci was run.
if command -v wsl >/dev/null 2>&1; then
  # If the WSL clone has node_modules, run validation there (safe path)
  if wsl -e bash -lc "[ -d ~/nitsuah-io-wsl/node_modules ]" >/dev/null 2>&1; then
    echo "Running validation inside WSL clone ~/nitsuah-io-wsl..."
    if wsl -e bash -lc "cd ~/nitsuah-io-wsl && npx --yes prettier --config config/prettier.config.json --write 'src/**/*.{js,jsx,ts,tsx,json,css}' && git add -A && npm run validate --silent"; then
      exit 0
    else
      echo "Validation failed inside WSL clone. Run 'npm ci' in ~/nitsuah-io-wsl or commit from the environment where dev deps are installed." >&2
      exit 1
    fi
  fi
fi

# If npm is available locally, run validation here
if command -v npm >/dev/null 2>&1 && command -v npx >/dev/null 2>&1; then
  if npx --yes prettier --config config/prettier.config.json --write "src/**/*.{js,jsx,ts,tsx,json,css}"; then
    git add -A || true
    if npm run validate --silent; then
      exit 0
    else
      echo "Validation failed. Run 'npm ci' to install dev dependencies and try again." >&2
      exit 1
    fi
  else
    echo "Prettier formatting failed. Ensure dev dependencies are installed: run 'npm ci'." >&2
    exit 1
  fi
fi

# Neither WSL nor local npm found â€” warn and allow the commit to proceed so users
# using minimal environments or credential helpers aren't blocked. Encourage them to
# run validation locally or in CI.
echo "WARNING: npm not found in PATH and WSL either; skipping pre-commit validation."
echo "To enable hooks, run 'npm ci' in your environment or commit from WSL where npm is installed."
exit 0



